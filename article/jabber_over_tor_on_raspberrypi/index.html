<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

    <title> Анонимный jabber средствами TOR на rapsberry pi | c r y p t o p u n k s  </title>
    <meta name="description" content="Настраиваем свой анонимный сервер jabber на raspberry pi без покупки домена и без анонимного хостера" />
    <meta property="og:title"       content= "Анонимный jabber средствами TOR на rapsberry pi | c r y p t o p u n k s"  />
    <meta property="og:description" content= "Настраиваем свой анонимный сервер jabber на raspberry pi без покупки домена и без анонимного хостера"  />
    <meta property="og:site_name" content="c r y p t o p u n k s" />
    <meta property="og:locale" content="ru_RU" />
    <meta property="og:type" content= "article"  />
    <meta property="og:url" content="https://cryptopunks.org/article/jabber_over_tor_on_raspberrypi/" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />

</head>

<body>

<header class="site-head" >
    <div class="vertical">
        <div class="inner">
            
            <h1 class="blog-title"><a href='/'>cryptopunks</a></h1>
            <!--            <h2 class="blog-description">  -->
                <nav id="site-navigation" class="main-navigation">
                  <div>
                    <ul class="menu_top">
                      <li><a href='/tags/'>tags</a></li>
                      <li><a href='/sitemap/'>sitemap</a></li>
                      <li><a href='/contacts/'>contacts</a></li>
                      <li><a href='/donate/'>donate</a></li>
                      <li class="rss"><a href='/rss.xml'>rss</a></li>
                    </ul>
                  </div>
                </nav>
                <!--            </h2>-->
        </div>
    </div>
</header>


    <main class="content" role="main">
    <article class="post">
        <span class="post-meta">
        	<time datetime="2017-05-11">11/05/2017</time>
  
  <span class="tags">
    
    <a href="/tags/#linux" title="linux">#linux</a>
    
    <a href="/tags/#tor" title="tor">#tor</a>
    
    <a href="/tags/#prosody" title="prosody">#prosody</a>
    
    <a href="/tags/#jabber" title="jabber">#jabber</a>
    
    <a href="/tags/#onion" title="onion">#onion</a>
    
    <a href="/tags/#raspberrypi" title="raspberrypi">#raspberrypi</a>
    
  </span>
  
       	</span>

        <h1 class="post-title">Анонимный jabber средствами TOR на rapsberry pi</h1>

        <section class="post-content">
            <p>Задача вроде довольно банальная и очевидная, но меня постоянно заваливают письмами об анонимном мессенджере и вопросами вроде &quot;какого анонимного хостера знаешь, нужен анонимный жаббер&quot;, поэтому решил вместо тысячи ответов давать линк на одну статью.</p>

<p>У схемы <strong>jabber</strong> + <strong>tor</strong> + <strong>rapsberry pi</strong> есть ряд плюсов:</p>

<ol>
<li>не придётся покупать доменное имя

<ul>
<li>не нужно ничего оплачивать ежегодно</li>
<li>никто не отследит по денежным транзакциям кто владелец</li>
<li>домен не угонят (естественно всё относительно, ведь могут украсть ключи) и никто не забанит и не отключит домен</li>
</ul></li>
<li>не придётся искать и покупать анонимного хостера, а если он и анонимный, то нет гарантии в отказе слива информации о вас. Плюс их услуги довольно дорогие и часто отсуствует качество предоставляемых услуг, потому как довольно маленькая конкуренция</li>
<li>дешёвое обслуживание (всего 4Вт)</li>
<li>отсутствие левых владельцев, которым следует верить, что у них всё &quot;на самом деле отключено и ничего не сливается третьим лицам&quot;.</li>
<li>rapsberry pi может находиться за кучей натов и ей не нужно пробрасывание портов и тем более выделенный IP</li>
<li>местонахождение сервера будет никому не известно, кроме владельца</li>
</ol>

<p>(почти все перечисленные преимущества — TOR)</p>

<h2>Установка необходимых пакетов</h2>

<p>Процесс установки опустим, т.к. по этому шагу написана не одна тысяча материалов, скажу лишь, что лучше ставить <a href="https://downloads.raspberrypi.org/raspbian_lite_latest">Raspbian Lite</a>, т.к. чем меньше у нас будет изначально пакетов, тем лучше.</p>

<p>Далее необходимо определиться с jabber-сервером. Тут варинтов не очень много, мы выберем в этой роли prosody, он молод и интенсивно развиваем.</p>

<p>Ставим необходимые пакеты:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo apt install tor prosody
</code></pre></figure>
<h2>Генерация домена</h2>

<p>Более подброно про генерацию доменов в TOR можно в статье, <a href="/article/generate+custom+onion+address/">написанной ранее</a>, но если кратко:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ printf &quot;HiddenServiceDir /var/lib/tor/jabber\nHiddenServicePort 5222 127.0.0.1:5222\n&quot; | sudo tee /etc/tor/torrc
$ sudo systemctl tor restart
$ sudo cat /var/lib/tor/jabber/hostname
pigf5kfufjz63s5z.onion
</code></pre></figure>
<p><strong>pigf5kfufjz63s5z.onion</strong> — домен, который мы будем использовать в jabber-сервере.</p>

<p>Далее создаём конфиг <strong>/etc/prosody/prosody.cfg.lua</strong> с примерно таким содержанием:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">admins = { &quot;root@nsltzcvhmzfa7ypr.onion&quot; }
modules_enabled = {

    -- Generally required
        &quot;roster&quot;; -- Allow users to have a roster. Recommended ;)
        &quot;saslauth&quot;; -- Authentication for clients and servers. Recommended if you want to log in.
        &quot;tls&quot;; -- Add support for secure TLS on c2s/s2s connections
        -- &quot;dialback&quot;; -- s2s dialback support
        -- &quot;disco&quot;; -- Service discovery

    -- Not essential, but recommended
        &quot;private&quot;; -- Private XML storage (for room bookmarks, etc.)
        &quot;vcard&quot;; -- Allow users to set vCards

    -- These are commented by default as they have a performance impact
        --&quot;privacy&quot;; -- Support privacy lists
        --&quot;compression&quot;; -- Stream compression (Debian: requires lua-zlib module to work)

    -- Nice to have
        &quot;version&quot;; -- Replies to server version requests
        &quot;uptime&quot;; -- Report how long server has been running
        &quot;time&quot;; -- Let others know the time here on this server
        &quot;ping&quot;; -- Replies to XMPP pings with pongs
        &quot;pep&quot;; -- Enables users to publish their mood, activity, playing music and more
        -- &quot;register&quot;; -- Allow users to register on this server using a client and change passwords

    -- Admin interfaces
        -- &quot;admin_adhoc&quot;; -- Allows administration via an XMPP client that supports ad-hoc commands
        --&quot;admin_telnet&quot;; -- Opens telnet console interface on localhost port 5582

    -- HTTP modules
        --&quot;bosh&quot;; -- Enable BOSH clients, aka &quot;Jabber over HTTP&quot;
        --&quot;http_files&quot;; -- Serve static files from a directory over HTTP

    -- Other specific functionality
        &quot;posix&quot;; -- POSIX functionality, sends server to background, enables syslog, etc.
        --&quot;groups&quot;; -- Shared roster support
        --&quot;announce&quot;; -- Send announcement to all online users
        --&quot;welcome&quot;; -- Welcome users who register accounts
        --&quot;watchregistrations&quot;; -- Alert admins of registrations
        --&quot;motd&quot;; -- Send a message to users when they log in
        --&quot;legacyauth&quot;; -- Legacy authentication. Only used by some old clients and bots.
};

modules_disabled = {
    -- &quot;offline&quot;; -- Store offline messages
    -- &quot;c2s&quot;; -- Handle client connections
    &quot;s2s&quot;; -- Handle server-to-server connections
};

allow_registration = true;

daemonize = true;

pidfile = &quot;/var/run/prosody/prosody.pid&quot;;

c2s_require_encryption = true 

authentication = &quot;internal_hashed&quot;

log = {
    -- Log files (change &#39;info&#39; to &#39;debug&#39; for debug logs):
    info = &quot;/dev/null&quot;;
    error = &quot;/dev/null&quot;;
    -- Syslog:
    { levels = { &quot;error&quot; }; to = &quot;syslog&quot;;  };
}

VirtualHost &quot;nsltzcvhmzfa7ypr.onion&quot;
    enabled = true -- Remove this line to enable this host

    ssl = {
        key = &quot;/etc/prosody/certs/host.key&quot;;
        certificate = &quot;/etc/prosody/certs/host.crt&quot;;
    }


Include &quot;conf.d/*.cfg.lua&quot;
</code></pre></figure>
<p>Все вхождения <strong>pigf5kfufjz63s5z.onion</strong> необходимо поменять на тот домен, который сгенерировался у вас.</p>

<h2>Создание ключей ssl</h2>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo openssl req -new -x509 -days 365 -nodes -out &quot;/etc/prosody/certs/host.crt&quot; -newkey rsa:2048 -keyout &quot;/etc/prosody/certs/host.key&quot;
</code></pre></figure>
<p>После чего перезапускаем prosody:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo systemctl prosody restart
</code></pre></figure>
<h2>Настройка клиентской стороны</h2>

<p>На клиентской стороне ставим и запускаем TOR:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo apt install tor
$ sudo systemctl tor restart
</code></pre></figure>
<p>А в клиенте jabber выбираем в свойствах соединения Socks5-прокси, в качестве <strong>Host</strong> указываем <strong>127.0.0.1</strong> в качестве <strong>Port</strong> — <strong>9050</strong>. Пишем логин (если логина ещё нет — регистрируемся, выбрав соответствующий пункт меню в клиенте), а в качестве хоста сервера указываем ваш свежесгенерированный onion-ресурс (в моём случае это pigf5kfufjz63s5z.onion).</p>

<p>Регистрацию так же можно сделать закрытой (для &quot;своих&quot;) поменяв в конфиге prosody <strong>allow_registration</strong> с <strong>true</strong> на <strong>false</strong>, тогда регистрировать пользователей можно из консоли:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo prosodyctl register имя_пользоавтеля ваш_onion_домен пароль_пользователя
</code></pre></figure>
<p>Остальные тонкости настройки <a href="https://prosody.im/doc/configure">на официальной странице</a>.</p>

<h2>Напоследок несколько важных нюансов</h2>

<p>Не забываем на малинке поменять пароль для <strong>pi</strong>, <strong>root</strong>, настроить <a href="/article/secure+and+comfortable+ssh/">соответствующим образом ssh</a>, запустить <code>netstat -tulpan</code> и убедиться что никаких левых сервисов не запущено (как правило светят наружу ненужные ntpd, avahi-daemon, dhcpcd — всё лишнее удаляем через <code>apt purge имя_пакета</code>), либо вообще запрещаем все порты кроме 9050 фаерволлом (об этом можно почитать, например, <a href="/article/ufw+firewall/">тут</a>. Ещё можно поставить и минимально настроить <strong>fail2ban</strong> и <a href="/article/enabling+automatic+updates+in+debian/">включить автоматические обновления ОС</a>.</p>

<p>Кстати, если в вашей стране TOR блокируется, то поможет вот <a href="/article/tor+blocking+bypass/">эта статья</a>.</p>

<p>Удачной анонимной и относительно безопасной переписки на личном одноплатном сервере!</p>

<p><br>
Напомню, что если наши статьи вам понравились, можно <a href="/donate/">поддержать проект материально</a>, либо <a href="/contacts/">оставив отзыв</a> (критика тоже приветствуется).</p>

        </section>

        

        <footer class="post-footer">
        	<!-- If we want to display author's name and bio -->
            

            <section class="share">
                <h4>Поделиться</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Анонимный jabber средствами TOR на rapsberry pi&amp;url=https://cryptopunks.org/article/jabber_over_tor_on_raspberrypi/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://cryptopunks.org/article/jabber_over_tor_on_raspberrypi/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://cryptopunks.org/article/jabber_over_tor_on_raspberrypi/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            <a href="/contacts" class="dsq-brlink">Оставить комментарий</a>
            

        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Подписаться на RSS</span></a>
        <div class="inner">
            <section class="copyright">&copy; 2014-2019 <a href="https://cryptopunks.org">c r y p t o p u n k s</a></section>
            <div class="mirrorblock">
              Mirrors:<br>
                <a href="https://cryptopunks.org">cryptopunks.org</a><br>
                <a href="http://crptpnkdgddolfag.onion">crptpnkdgddolfag.onion</a>
            </div>
        </div>
    </footer>


    <script type="text/javascript" src="/assets/js/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
