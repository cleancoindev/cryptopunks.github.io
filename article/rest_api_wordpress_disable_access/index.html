<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

    <title> Отключение Rest API в Wordpress для неавторизированных пользователей | c r y p t o p u n k s  </title>
    <meta name="description" content="Демонстрация уязвимости и отлючение Rest API в Wordpress для большей безопасности сайта" />
    <meta property="og:title"       content= "Отключение Rest API в Wordpress для неавторизированных пользователей | c r y p t o p u n k s"  />
    <meta property="og:description" content= "Демонстрация уязвимости и отлючение Rest API в Wordpress для большей безопасности сайта"  />
    <meta property="og:site_name" content="c r y p t o p u n k s" />
    <meta property="og:locale" content="ru_RU" />
    <meta property="og:type" content= "article"  />
    <meta property="og:url" content="https://cryptopunks.org/article/rest_api_wordpress_disable_access/" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />

</head>

<body>

<header class="site-head" >
    <div class="vertical">
        <div class="inner">
            
            <h1 class="blog-title"><a href='/'>cryptopunks</a></h1>
            <!--            <h2 class="blog-description">  -->
                <nav id="site-navigation" class="main-navigation">
                  <div>
                    <ul class="menu_top">
                      <li><a href='/tags/'>tags</a></li>
                      <li><a href='/sitemap/'>sitemap</a></li>
                      <li><a href='/contacts/'>contacts</a></li>
                      <li><a href='/donate/'>donate</a></li>
                      <li class="rss"><a href='/rss.xml'>rss</a></li>
                    </ul>
                  </div>
                </nav>
                <!--            </h2>-->
        </div>
    </div>
</header>


    <main class="content" role="main">
    <article class="post">
        <span class="post-meta">
        	<time datetime="2019-04-08">08/04/2019</time>
  
  <span class="tags">
    
    <a href="/tags/#wordpress" title="wordpress">#wordpress</a>
    
    <a href="/tags/#bruteforce" title="bruteforce">#bruteforce</a>
    
    <a href="/tags/#restapi" title="restapi">#restapi</a>
    
    <a href="/tags/#security" title="security">#security</a>
    
  </span>
  
       	</span>

        <h1 class="post-title">Отключение Rest API в Wordpress для неавторизированных пользователей</h1>

        <section class="post-content">
            <p>Rest API в Wordpress — несомненно очень удобный инструмент, однако совершенно случайно я обнаружил ряд потенциально опасных лазеек, которыми могут воспользоваться хакеры при взломе вашего сайта. Одной из них я хотел бы поделиться и рассказать о том, как отключить этот функционал для неавторизированных пользователей, т.к. чаще всего Rest API либо вообще не используется, либо используется для администрирования сайта.</p>

<h2>Демонстрация одной из опасных проблем</h2>

<p>В документации к <a href="https://developer.wordpress.org/rest-api/using-the-rest-api/">Rest API Wordpress</a>  есть запрос следующего вида <strong>/wp-json/wp/v2/users</strong>. Он позволяет получить список зарегистрированных юзеров на сайте, в том числе их логины для входа.</p>

<p>Например, давайте получим часть логинов на xakep.ru:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ curl &quot;http://xakep.ru/wp-json/wp/v2/users&quot;
[{&quot;id&quot;:64,&quot;name&quot;:&quot;|plaintext|&quot;,&quot;url&quot;:&quot;&quot;,&quot;description&quot;:&quot;&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru\/author\/plaintext\/&quot;,&quot;slug&quot;:&quot;plaintext&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;http:\/\/1.gravatar.com\/avatar\/1d2b0b979683a00ea63f7e3ab319964c?s=24&amp;d=retro&amp;r=g&quot;,&quot;48&quot;:&quot;http:\/\/1.gravatar.com\/avatar\/1d2b0b979683a00ea63f7e3ab319964c?s=48&amp;d=retro&amp;r=g&quot;,&quot;96&quot;:&quot;http:\/\/1.gravatar.com\/avatar\/1d2b0b979683a00ea63f7e3ab319964c?s=96&amp;d=retro&amp;r=g&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/64&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}},{&quot;id&quot;:429154,&quot;name&quot;:&quot;0x25CBFC4F&quot;,&quot;url&quot;:&quot;&quot;,&quot;description&quot;:&quot;&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru\/author\/0x25cbfc4f\/&quot;,&quot;slug&quot;:&quot;0x25cbfc4f&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;http:\/\/1.gravatar.com\/avatar\/7f12c015398c2326135d4800f93bad20?s=24&amp;d=retro&amp;r=g&quot;,&quot;48&quot;:&quot;http:\/\/1.gravatar.com\/avatar\/7f12c015398c2326135d4800f93bad20?s=48&amp;d=retro&amp;r=g&quot;,&quot;96&quot;:&quot;http:\/\/1.gravatar.com\/avatar\/7f12c015398c2326135d4800f93bad20?s=96&amp;d=retro&amp;r=g&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/429154&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}},{&quot;id&quot;:417792,&quot;name&quot;:&quot;0x6d696368&quot;,&quot;url&quot;:&quot;&quot;,&quot;description&quot;:&quot;Computer magician&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru\/author\/0x6d696368\/&quot;,&quot;slug&quot;:&quot;0x6d696368&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;https:\/\/xakep.ru\/wp-content\/uploads\/2018\/05\/author-s.jpg&quot;,&quot;48&quot;:&quot;https:\/\/xakep.ru\/wp-content\/uploads\/2018\/05\/author-s.jpg&quot;,&quot;96&quot;:&quot;https:\/\/xakep.ru\/wp-content\/uploads\/2018\/05\/author-s.jpg&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/417792&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}},{&quot;id&quot;:329699,&quot;name&quot;:&quot;84ckf1r3&quot;,&quot;url&quot;:&quot;&quot;,&quot;description&quot;:&quot;&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru\/author\/84ckf1r3\/&quot;,&quot;slug&quot;:&quot;84ckf1r3&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/3b7926f0e4a268a785b8e9c97aea91be?s=24&amp;d=retro&amp;r=g&quot;,&quot;48&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/3b7926f0e4a268a785b8e9c97aea91be?s=48&amp;d=retro&amp;r=g&quot;,&quot;96&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/3b7926f0e4a268a785b8e9c97aea91be?s=96&amp;d=retro&amp;r=g&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/329699&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}},{&quot;id&quot;:341793,&quot;name&quot;:&quot;8bit&quot;,&quot;url&quot;:&quot;&quot;,&quot;description&quot;:&quot;&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru\/author\/8bit\/&quot;,&quot;slug&quot;:&quot;8bit&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/c50d7b552ac9909795ceacdf50fcbf38?s=24&amp;d=retro&amp;r=g&quot;,&quot;48&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/c50d7b552ac9909795ceacdf50fcbf38?s=48&amp;d=retro&amp;r=g&quot;,&quot;96&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/c50d7b552ac9909795ceacdf50fcbf38?s=96&amp;d=retro&amp;r=g&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/341793&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}},{&quot;id&quot;:339280,&quot;name&quot;:&quot;Al1en&quot;,&quot;url&quot;:&quot;&quot;,&quot;description&quot;:&quot;&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru&quot;,&quot;slug&quot;:&quot;al1en&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/900c621598b832a109a7659db0d42de9?s=24&amp;d=retro&amp;r=g&quot;,&quot;48&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/900c621598b832a109a7659db0d42de9?s=48&amp;d=retro&amp;r=g&quot;,&quot;96&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/900c621598b832a109a7659db0d42de9?s=96&amp;d=retro&amp;r=g&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/339280&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}},{&quot;id&quot;:7,&quot;name&quot;:&quot;Alex G&quot;,&quot;url&quot;:&quot;&quot;,&quot;description&quot;:&quot;&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru&quot;,&quot;slug&quot;:&quot;fotonstep&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;https:\/\/xakep.ru\/wp-content\/uploads\/2016\/12\/ava-new-large.jpg&quot;,&quot;48&quot;:&quot;https:\/\/xakep.ru\/wp-content\/uploads\/2016\/12\/ava-new-large.jpg&quot;,&quot;96&quot;:&quot;https:\/\/xakep.ru\/wp-content\/uploads\/2016\/12\/ava-new-large.jpg&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/7&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}},{&quot;id&quot;:351044,&quot;name&quot;:&quot;aLLy&quot;,&quot;url&quot;:&quot;http:\/\/russiansecurity.expert\/&quot;,&quot;description&quot;:&quot;\u0421\u043f\u0435\u0446\u0438\u0430\u043b\u0438\u0441\u0442 \u043f\u043e \u0438\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u043e\u043d\u043d\u043e\u0439 \u0431\u0435\u0437\u043e\u043f\u0430\u0441\u043d\u043e\u0441\u0442\u0438 \u0432 ONsec.\r\nResearch, ethical hacking and Photoshop.&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru\/author\/iamsecurity\/&quot;,&quot;slug&quot;:&quot;iamsecurity&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;http:\/\/1.gravatar.com\/avatar\/78da81286e3e78c6338efbb98f47680d?s=24&amp;d=retro&amp;r=g&quot;,&quot;48&quot;:&quot;http:\/\/1.gravatar.com\/avatar\/78da81286e3e78c6338efbb98f47680d?s=48&amp;d=retro&amp;r=g&quot;,&quot;96&quot;:&quot;http:\/\/1.gravatar.com\/avatar\/78da81286e3e78c6338efbb98f47680d?s=96&amp;d=retro&amp;r=g&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/351044&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}},{&quot;id&quot;:337436,&quot;name&quot;:&quot;Anton Ostrokonskiy&quot;,&quot;url&quot;:&quot;http:\/\/ostrokonskiy.com&quot;,&quot;description&quot;:&quot;Penetration tester&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru\/author\/pagliacci\/&quot;,&quot;slug&quot;:&quot;pagliacci&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;https:\/\/xakep.ru\/wp-content\/uploads\/2017\/06\/b9909cefd3f7b9a34b8f85e1270ad11a.jpeg&quot;,&quot;48&quot;:&quot;https:\/\/xakep.ru\/wp-content\/uploads\/2017\/06\/b9909cefd3f7b9a34b8f85e1270ad11a.jpeg&quot;,&quot;96&quot;:&quot;https:\/\/xakep.ru\/wp-content\/uploads\/2017\/06\/b9909cefd3f7b9a34b8f85e1270ad11a.jpeg&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/337436&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}},{&quot;id&quot;:51,&quot;name&quot;:&quot;ARNext.ru&quot;,&quot;url&quot;:&quot;http:\/\/arnext.ru&quot;,&quot;description&quot;:&quot;\u041a\u0440\u0443\u043f\u043d\u0435\u0439\u0448\u0438\u0439 \u0440\u0443\u0441\u0441\u043a\u043e\u044f\u0437\u044b\u0447\u043d\u044b\u0439 \u0440\u0435\u0441\u0443\u0440\u0441 \u043e \u0434\u043e\u043f\u043e\u043b\u043d\u0435\u043d\u043d\u043e\u0439, \u0432\u0438\u0440\u0442\u0443\u0430\u043b\u044c\u043d\u043e\u0439 \u0440\u0435\u0430\u043b\u044c\u043d\u043e\u0441\u0442\u0438 \u0438 \u0441\u043e\u043f\u0443\u0442\u0441\u0442\u0432\u0443\u044e\u0449\u0438\u0445 \u0442\u0435\u0445\u043d\u043e\u043b\u043e\u0433\u0438\u044f\u0445.&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru\/author\/arnext\/&quot;,&quot;slug&quot;:&quot;arnext&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;http:\/\/2.gravatar.com\/avatar\/e89a0ded334cee51dc273d169c028d1f?s=24&amp;d=retro&amp;r=g&quot;,&quot;48&quot;:&quot;http:\/\/2.gravatar.com\/avatar\/e89a0ded334cee51dc273d169c028d1f?s=48&amp;d=retro&amp;r=g&quot;,&quot;96&quot;:&quot;http:\/\/2.gravatar.com\/avatar\/e89a0ded334cee51dc273d169c028d1f?s=96&amp;d=retro&amp;r=g&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/51&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}}]%
</code></pre></figure>
<p>Или можно узнать какой логин например у пользователя с <strong>id=1</strong> (с большой долей вероятности — администратора сайта):</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ curl http://xakep.ru/wp-json/wp/v2/users/1
{&quot;id&quot;:1,&quot;name&quot;:&quot;wpengine&quot;,&quot;url&quot;:&quot;http:\/\/wpengine.com&quot;,&quot;description&quot;:&quot;This is the \&quot;wpengine\&quot; admin user that our staff uses to gain access to your admin area to provide support and troubleshooting. It can only be accessed by a button in our secure log that auto generates a password and dumps that password after the staff member has logged in. We have taken extreme measures to ensure that our own user is not going to be misused to harm any of our clients sites.&quot;,&quot;link&quot;:&quot;https:\/\/xakep.ru&quot;,&quot;slug&quot;:&quot;wpengine&quot;,&quot;avatar_urls&quot;:{&quot;24&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/9315f6ce3baebb09c86901c4497d57b7?s=24&amp;d=retro&amp;r=g&quot;,&quot;48&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/9315f6ce3baebb09c86901c4497d57b7?s=48&amp;d=retro&amp;r=g&quot;,&quot;96&quot;:&quot;http:\/\/0.gravatar.com\/avatar\/9315f6ce3baebb09c86901c4497d57b7?s=96&amp;d=retro&amp;r=g&quot;},&quot;meta&quot;:[],&quot;_links&quot;:{&quot;self&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users\/1&quot;}],&quot;collection&quot;:[{&quot;href&quot;:&quot;https:\/\/xakep.ru\/wp-json\/wp\/v2\/users&quot;}]}}%
</code></pre></figure>
<p>А вот и он <strong>wpengine</strong>.</p>

<p>Теперь при брутфорсинге пароля хакер может знать какой логин использовать.</p>

<h2>Ограничиваем доступ к Rest API Wordpress</h2>

<p>А теперь давайте эту лазейку прикроем, разрешив использовать Rest API только авторизированным пользователям. Для этого необходимо в файлики, которые обчно не подвержены перезаписи (обновлению) и вызываются при каждом запросе к сайту добавить следующий код:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">## Закрывает все маршруты REST API от публичного доступа
add_filter( &#39;rest_authentication_errors&#39;, function( $result ){

    if( empty( $result ) &amp;&amp; ! current_user_can(&#39;edit_others_posts&#39;) ){
        return new WP_Error( &#39;rest_forbidden&#39;, &#39;You are not currently logged in.&#39;, array( &#39;status&#39; =&gt; 401 ) );
    }

    return $result;
});
</code></pre></figure>
<p>Например, можно добавить этот код в самый конец файла <strong>wp-config.php</strong>.</p>

<h2>Напоследок</h2>

<p>Ну и разумеется, смысл в вышепреведённом коде есть при условии, что регистрация на вашем сайте отключена.
В противном случае условие это необходимо немного модифицировать по ситуации.</p>

        </section>

        

        <footer class="post-footer">
        	<!-- If we want to display author's name and bio -->
            

            <section class="share">
                <h4>Поделиться</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Отключение Rest API в Wordpress для неавторизированных пользователей&amp;url=https://cryptopunks.org/article/rest_api_wordpress_disable_access/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://cryptopunks.org/article/rest_api_wordpress_disable_access/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://cryptopunks.org/article/rest_api_wordpress_disable_access/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            <a href="/contacts" class="dsq-brlink">Оставить комментарий</a>
            

        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Подписаться на RSS</span></a>
        <div class="inner">
            <section class="copyright">&copy; 2014-2019 <a href="https://cryptopunks.org">c r y p t o p u n k s</a></section>
            <div class="mirrorblock">
              Mirrors:<br>
                <a href="https://cryptopunks.org">cryptopunks.org</a><br>
                <a href="https://cryptopunks.github.io">cryptopunks.github.io</a><br>
                <a href="http://crptpnkdgddolfag.onion">crptpnkdgddolfag.onion</a>
            </div>
        </div>
    </footer>


    <script type="text/javascript" src="/assets/js/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
