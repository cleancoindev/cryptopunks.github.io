<!DOCTYPE html>
<html lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />

    <title> Перенаправляем весь трафик через TOR | c r y p t o p u n k s  </title>
    <meta name="description" content="Tor-browser это хорошо, а TOR для всех программ на компьютере - ещё лучше" />
    <meta property="og:title"       content= "Перенаправляем весь трафик через TOR | c r y p t o p u n k s"  />
    <meta property="og:description" content= "Tor-browser это хорошо, а TOR для всех программ на компьютере - ещё лучше"  />
    <meta property="og:site_name" content="c r y p t o p u n k s" />
    <meta property="og:locale" content="ru_RU" />
    <meta property="og:type" content= "article"  />
    <meta property="og:url" content="https://cryptopunks.org/article/forward+all+the+traffic+to+tor/" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" type="image/x-icon" href="/assets/images/favicon.ico"/>
    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />

</head>

<body>

<header class="site-head" >
    <div class="vertical">
        <div class="inner">
            
            <h1 class="blog-title"><a href='/'>cryptopunks</a></h1>
            <!--            <h2 class="blog-description">  -->
                <nav id="site-navigation" class="main-navigation">
                  <div>
                    <ul class="menu_top">
                      <li><a href='/tags/'>tags</a></li>
                      <li><a href='/sitemap/'>sitemap</a></li>
                      <li><a href='/contacts/'>contacts</a></li>
                      <li><a href='/donate/'>donate</a></li>
                      <li class="rss"><a href='/rss.xml'>rss</a></li>
                    </ul>
                  </div>
                </nav>
                <!--            </h2>-->
        </div>
    </div>
</header>


    <main class="content" role="main">
    <article class="post">
        <span class="post-meta">
        	<time datetime="2015-08-24">24/08/2015</time>
  
  <span class="tags">
    
    <a href="/tags/#tor" title="tor">#tor</a>
    
    <a href="/tags/#secure" title="secure">#secure</a>
    
    <a href="/tags/#forward" title="forward">#forward</a>
    
  </span>
  
       	</span>

        <h1 class="post-title">Перенаправляем весь трафик через TOR</h1>

        <section class="post-content">
            <h2>Для чего необходимо</h2>

<p>Бывают ситуации когда необходима анонимность, но VPN под рукой нет. И VPN вряд ли можно назвать анонимным инструментом, ведь вы на него заходите как правило со своего IP (если это не двойной VPN), а значит оставляете следы, даже если не ведутся логи. Что уж говорить о VPN-услугах, которые вы покупаете у чужих людей. Они в свою очередь чаще всего ведут и логи и сниффают трафик и при любом обращении местных спецслужб эту информацию послушно предоставляют.</p>

<p>TOR - неплохой инструмент для анонимности и иногда необходимо через него пропускать не только трафик из вашего браузера (что делает например tor-browser), но и вообще трафик всей системы + не все необходимые вам программы могут поддерживать socks-прокси.</p>

<h2>Установка и настройка TOR</h2>

<p>Устанавливаем:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo apt-get install tor
</code></pre></figure>
<p>Для настройки используется конфиг <strong>/etc/tor/torrc</strong>, открываем/создаём и вписываем туда следующее:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">VirtualAddrNetworkIPv4 10.192.0.0/10
AutomapHostsOnResolve 1
TransPort 9040
DNSPort 53
# для жителей СНГ рекомендую исключить Exit-ноды следующих стран
ExcludeExitNodes {RU},{UA},{BY}
</code></pre></figure>
<h2>Настройка DNS</h2>

<p>Использовать ДНС-сервера от Google, либо чьи-нибудь ещё - плохая идея, т.к. они тотчас вас деанонимизируют.
Будем использовать локальный ДНС средствами TOR. Для выполним следующее:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo rm -f /etc/resolv.conf # удалим, т.к. иногда это сим-линк
$ echo &quot;nameserver 127.0.0.1&quot; | sudo tee /etc/resolv.conf
</code></pre></figure>
<p>Поскольку всякие NetworkManager очень любят перезаписывать этот файл - лучше его вообще залочить на запись:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo chattr +i /etc/resolv.conf
</code></pre></figure>
<p>(для анлока вместо +i используйте -i)</p>

<h2>Настройка Iptables и проверка работоспособности</h2>

<p>Создаём скрипт <strong>iptables_setup.sh</strong>:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">#!/bin/sh

### set variables
#destinations you don&#39;t want routed through Tor
_non_tor=&quot;192.168.1.0/24 192.168.0.0/24&quot;

#the UID that Tor runs as (varies from system to system)
_tor_uid=&quot;XYZ&quot; # XYZ меняем на UID пользователя TOR (!)

#Tor&#39;s TransPort
_trans_port=&quot;9040&quot;

### flush iptables
iptables -F
iptables -t nat -F

### set iptables *nat
iptables -t nat -A OUTPUT -m owner --uid-owner $_tor_uid -j RETURN
iptables -t nat -A OUTPUT -p udp --dport 53 -j REDIRECT --to-ports 53

#allow clearnet access for hosts in $_non_tor
for _clearnet in $_non_tor 127.0.0.0/9 127.128.0.0/10; do
   iptables -t nat -A OUTPUT -d $_clearnet -j RETURN
done

#redirect all other output to Tor&#39;s TransPort
iptables -t nat -A OUTPUT -p tcp --syn -j REDIRECT --to-ports $_trans_port

### set iptables *filter
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

#allow clearnet access for hosts in $_non_tor
for _clearnet in $_non_tor 127.0.0.0/8; do
   iptables -A OUTPUT -d $_clearnet -j ACCEPT
done

#allow only Tor output
iptables -A OUTPUT -m owner --uid-owner $_tor_uid -j ACCEPT
iptables -A OUTPUT -j REJECT
</code></pre></figure>
<p>Переменную <code>_tor_uid</code> меняем на uid пользователя под которым работает tor.
Определить это значение можно так:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ grep tor /etc/passwd
debian-tor:x:135:145::/var/lib/tor:/bin/false
</code></pre></figure>
<p>Первая цифра, то есть 135 - uid, меняем в скрипте</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">_tor_uid=&quot;135&quot;
</code></pre></figure>
<p>Запускаем:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ chmod +x iptables_setup.sh
$ sudo ./iptables_setup.sh
</code></pre></figure>
<p>Проверяем работу. Включаем tor:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo /etc/init.d/tor restart
</code></pre></figure>
<p>Пробуем зайти на <a href="https://check.torproject.org/" target="_blank"><a href="https://check.torproject.org/">https://check.torproject.org/</a></a>. Должны увидеть надпись &quot;Congratulations. This browser is configured to use Tor&quot;.</p>

<p>Теперь останавливаем TOR:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo /etc/init.d/tor stop
</code></pre></figure>
<p>И повторно пробуем зайти на сайт, либо запускаем любую другую программу (например, IM-клиент), интернет не должен работать, т.к. выключен TOR.
Если всё верно, то прописываем правила iptables в автозагрузку:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo iptables-save &gt; /etc/iptables_tor
</code></pre></figure>
<p>Открываем файл <strong>/etc/rc.local</strong> и перед <strong>exit 0</strong> вставляем:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">iptables-restore &lt; /etc/iptables_tor
</code></pre></figure>
<p>Добавляем запуск TOR в автозагрузку:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">$ sudo update-rc.d tor enable
</code></pre></figure>
<h2>Отключение перенаправления трафика</h2>

<p>Для того чтобы привести правила iptables к девственному виду и отключить перенаправление трафика в сеть TOR можно создать скрипт со следующим содержанием:</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">#!/bin/sh

echo &quot;Stopping firewall and allowing everyone...&quot;
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

</code></pre></figure>
<h2>Несколько советов</h2>

<ul>
<li><p>Неплохим вариантом будет использование на хосте VPN, а в виртуальной машине TOR, но в некоторых случаях лучше действовать наоборот. Зависит от того, какие цели вы преследуете.</p></li>
<li><p>Если необходимо скрыть от местного провайдера ваше использование TOR, то запускайте TOR внутри VPN.</p></li>
<li><p>Если же необходима более серьёзная анонимность и постоянный IP (некоторые сайты блокируют, или не любят TOR - капчи хороший тому пример), то заведите девственно чистую виртуальную машину с <a href="/article/change+random+mac+address/" target="_blank">левым MAC-адресом сетевой платы</a>, а в ней чистый профиль браузера и под ним (ес-но тоже под TOR) зарегистрируйте либо VPS-сервер (для последующей настройки VPN), либо уже готовый VPN-сервер, пользуясь анонимной валютой (qiwi с левой симкой, либо bitcoin) и левыми ФИО и мылом (который тоже зарегайте под тором в этой виртуалке) и используйте свежезарегистрированные почту/vpn исключительно в этой виртуалке, никогда не входите под ней в свою основную почту, социальные сети и т.д. (тоже самое с свежезареганной почтой и vpn - лишь в текущей виртуалке), т.к. достаточного одного раза, чтобы ваша вторая личность была навсегда связана с основной и тогда получится что все труды были напрасны.</p></li>
<li><p>Ещё неплохой идеей будет запускать TOR в chroot-окружении. В интернете немало информации по настройке, например: <a href="https://trac.torproject.org/projects/tor/wiki/doc/TorInChroot" target="_blank">https://trac.torproject.org/projects/tor/wiki/doc/TorInChroot</a> (единственный плохой совет в статье - ставить TOR из исходников, ставьте лишь из репозитория вашего дистрибутива и регулярно обновляйте его и всю систему). Это дополнительно обезопасит вас от критических уязвимостей найденных в системе которую вы используете и в TOR. Хотя ещё лучшей идеей будет настроить TOR на отдельном роутере в chroot окружении, но это уже если у вас true-паранойя.</p></li>
</ul>

        </section>

        

        <footer class="post-footer">
        	<!-- If we want to display author's name and bio -->
            

            <section class="share">
                <h4>Поделиться</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Перенаправляем весь трафик через TOR&amp;url=https://cryptopunks.org/article/forward+all+the+traffic+to+tor/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://cryptopunks.org/article/forward+all+the+traffic+to+tor/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://cryptopunks.org/article/forward+all+the+traffic+to+tor/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
            <a href="/contacts" class="dsq-brlink">Оставить комментарий</a>
            

        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="/rss.xml"><span class="tooltip">Подписаться на RSS</span></a>
        <div class="inner">
            <section class="copyright">&copy; 2014-2019 <a href="https://cryptopunks.org">c r y p t o p u n k s</a></section>
            <div class="mirrorblock">
              Mirrors:<br>
                <a href="https://cryptopunks.org">cryptopunks.org</a><br>
                <a href="http://crptpnkdgddolfag.onion">crptpnkdgddolfag.onion</a>
            </div>
        </div>
    </footer>


    <script type="text/javascript" src="/assets/js/jquery-1.12.3.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
